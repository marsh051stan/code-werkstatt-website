name: Build and Deploy Static Site

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build static site
      run: bun run build
      env:
        NODE_ENV: production

    - name: Verify build output
      run: |
        echo "Checking build output..."
        ls -la
        if [ -d "website" ]; then
          echo "‚úÖ Website directory created successfully"
          echo "Contents:"
          ls -la website/
          echo "Total files in website:"
          find website -type f | wc -l
        else
          echo "‚ùå Website directory not found!"
          exit 1
        fi

    - name: Create static site archive
      run: |
        cd website
        zip -r ../code-werkstatt-website.zip .
        cd ..
        echo "Archive created: $(ls -lh code-werkstatt-website.zip)"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: static-website
        path: code-werkstatt-website.zip
        retention-days: 30

    - name: Create Release (on main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: release-${{ github.run_number }}
        name: Code Werkstatt Website v${{ github.run_number }}
        body: |
          üöÄ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∞–π—Ç–∞ Code Werkstatt**

          üìÖ **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏**: ${{ github.event.head_commit.timestamp }}
          üî® **–ö–æ–º–º–∏—Ç**: ${{ github.sha }}
          üí¨ **–°–æ–æ–±—â–µ–Ω–∏–µ**: ${{ github.event.head_commit.message }}

          ## üì¶ –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:
          - ‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∞–π—Ç (HTML/CSS/JS)
          - ‚úÖ –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–µ—Å—É—Ä—Å—ã
          - ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–∞
          - ‚úÖ –ß–∏—Å—Ç—ã–µ URL –±–µ–∑ .html
          - ‚úÖ –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é

          ## üåê –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
          1. –°–∫–∞—á–∞–π—Ç–µ `code-werkstatt-website.zip`
          2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
          3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞ –≤–∞—à –≤–µ–±-—Ö–æ—Å—Ç–∏–Ω–≥
          4. –ì–æ—Ç–æ–≤–æ! üéâ

          ---
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–æ GitHub Actions ü§ñ
        files: |
          code-werkstatt-website.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
